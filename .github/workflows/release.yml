name: Release

permissions: {}

on:
  push:
    tags: ["v*.*.*"]

jobs:
  release:
    name: Release
    uses: grafana/xk6/.github/workflows/extension-release.yml@v1.1.4
    permissions:
      contents: write
    with:
      go-version: "1.24.x"
      os: '["linux"]'
      arch: '["amd64"]'
      k6-version: "v1.2.3"
      xk6-version: "1.1.4"

  register-version:
    name: Register Version
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.K6_EXTENSION_REGISTRY_UPDATER_ID }}
          private-key: ${{ secrets.K6_EXTENSION_REGISTRY_UPDATER_PEM }}
          repositories: k6-extension-registry  # Grant access to target repo

      - name: Register version in k6 extension registry
        uses: pablochacin/k6-extension-registry/actions/register-version@add-update-version-action
        with:
          module: github.com/pablochacin/xk6-example
          version: ${{ github.ref_name }}
          token: ${{ steps.app-token.outputs.token }}
